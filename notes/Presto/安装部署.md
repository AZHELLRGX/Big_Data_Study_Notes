## Presto安装

### Presto Server安装

#### 官网地址

https://prestodb.github.io/

#### 下载地址

https://repo1.maven.org/maven2/com/facebook/presto/presto-server/0.196/presto-server-0.196.tar.gz

#### 解压

> 本次模拟在101集群操作，以下操作在集群节点均一致

```shell
# 将presto-server-0.196.tar.gz解压到指定目录
tar -zxvf presto-server-0.196.tar.gz
# 重命名
mv presto-server-0.196/ presto
# 进入到presto目录，并创建存储数据文件夹
mkdir data
# 进入到presto目录，并创建存储配置文件文件夹
mkdir etc
```

#### JVM配置

在etc目录下添加jvm.config配置文件

```shell
vim jvm.config
```

添加如下内容

> -server
> -Xmx16G
> -XX:+UseG1GC
> -XX:G1HeapRegionSize=32M
> -XX:+UseGCOverheadLimit
> -XX:+ExplicitGCInvokesConcurrent
> -XX:+HeapDumpOnOutOfMemoryError
> -XX:+ExitOnOutOfMemoryError

#### 配置数据源

Presto可以支持多个数据源，在Presto里面叫catalog，这里我们配置支持Hive的数据源，配置一个Hive的catalog

```shell
cd etc
mkdir catalog
vim hive.properties 
```

```properties
# 连接名称 帮助Presto识别服务类型
connector.name=hive-hadoop2
# 连接地址
hive.metastore.uri=thrift://node00:9083
```

还可以配置一个Mysql的Catalog

```properties
connector.name=mysql
connection-url=jdbc:mysql://192.168.1.71:3306
# 指定用户名密码
connection-user=dtauser
connection-password=dtauser
```

配置Phoenix的Catalog【貌似当前的Presto不再支持Phoenix，后续可以关注一下[trinodb](https://github.com/trinodb)】

```properties
connector.name=phoenix
case-insensitive-name-matching=true
phoenix.connection-url=jdbc:phoenix:192.168.2.101:2181:/rgx
phoenix.config.resources=/home/hmaster/MyCloudera/APP/hbase/conf/hbase-site.xml,/home/hmaster/MyCloudera/APP/hadoop/hadoop/etc/hadoop/core-site.xml,/home/hmaster/MyCloudera/APP/hadoop/hadoop/etc/hadoop/hdfs-site.xml
```

找到了一些开源组件方案

```properties
connector.name=hbase
zookeeper-quorum=192.168.2.101:2181,192.168.2.102:2181,192.168.2.103:2181
zookeeper-client-port=2181
zookeeper-znode-parent=/hbase
hbase-cluster-distributed=true
presto-server-port=8881
random-schedule-redundant-split=false
meta-dir=/home/hmaster/rgx/bigdata_warehouse/presto/etc/presto/chbase
```

配置SQLSERVER

```properties
connector.name=sqlserver
connection-url=jdbc:sqlserver://192.168.1.50\newdb
connection-user=dtauser
connection-password=dtauser
```

#### 节点分发

将101上的presto分发到102、103，保证各个节点的Presto相对目录一致

分发之后，分别进入101、102、103三台主机的presto/etc的路径。配置node属性，**node id每个节点都不一样**。

```shell
vim node.properties
```

```properties
# 101
node.environment=production
node.id=ffffffff-ffff-ffff-ffff-ffffffffffff
# 这个地方可以写自己的Presto的data目录的绝对路径
node.data-dir=../data
# 102
node.environment=production
node.id=ffffffff-ffff-ffff-ffff-fffffffffffe
node.data-dir=../data
# 103
node.environment=production
node.id=ffffffff-ffff-ffff-ffff-fffffffffffd
node.data-dir=../data
```

#### coordinator-worker架构

Presto是由一个coordinator节点和多个worker节点组成。在101上配置成coordinator，在102、103上配置为worker。

101上配置coordinator节点

```shell
vim config.properties
```

> coordinator=true
> node-scheduler.include-coordinator=false
> http-server.http.port=8881
> query.max-memory=10GB
> discovery-server.enabled=true
> discovery.uri=http://node00:8881

102、103上配置worker节点

> coordinator=false
> http-server.http.port=8881
> query.max-memory=10GB
> discovery.uri=http://node00:8881

分别在101、102、103上启动Presto Server

```shell
# 前台启动Presto，控制台显示日志
bin/launcher run
# 后台启动Presto
bin/launcher start
# 重启
bin/launcher restart
```

日志查看路径 presto/data/var/log

### Presto命令行Client

#### 下载

https://repo1.maven.org/maven2/com/facebook/presto/presto-cli/0.196/presto-cli-0.196-executable.jar

将presto-cli-0.196-executable.jar上传到101的presto文件夹下

#### 安装

```shell
# 重命名
mv presto-cli-0.196-executable.jar prestocli
# 增加执行权限
chmod +x prestocli
# 启动prestocli
./prestocli --server hadoop102:8881 --catalog hive --schema default
```

#### Presto命令行操作

Presto的命令行操作，相当于Hive命令行操作。每个表必须要加上schema。

```sql
select * from schema.table limit 100
```

### Presto可视化Client

将yanagishima-18.0.zip上传到101的presto目录

解压缩yanagishima

```shell
unzip yanagishima-18.0.zip
cd yanagishima-18.0
```

进入到yanagishima-18.0/conf文件夹，编写yanagishima.properties配置

```shell
vim yanagishima.properties
```

添加如下内容

```shell
jetty.port=7080
presto.datasources=mastercom-presto
presto.coordinator.server.atguigu-presto=http://node00:8881
catalog.mastercom-presto=hive
schema.mastercom-presto=default
sql.query.engines=presto
```

在yanagishima-18.0路径下启动yanagishima

```shell
nohup bin/yanagishima-start.sh >y.log 2>&1 &
```

打开界面就可以进行操作

http://192.168.2.101:7080

 