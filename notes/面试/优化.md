# HBase



# Hive

## hive调优说一下

- 能做子查询就做子查询，子查询一定要在join操作前面做
- 小文件太多的时候，使用mapred.max.split.size配置【其实是一个MR配置】设置每个map读取的数据量
- 使用用in来代替join，但是低版本中可能不支持in语法，可以试用left semi join来代替in【[转载:left join和left semi join的联系和区别](https://www.cnblogs.com/zzhangyuhang/p/9792794.html)】
- 使用map join应对大表join小表的情况【当然高版本的hive已经自动实现优化，只需要配置判断小表的门限即可】
- 避免使用COUNT(DISTINCT col)操作，DISTINCT会将该列数据全部放到内存中去，使用类似HashSet的结构去达到去重目的;
- 根据当前数据量和资源合理设置Properties配置进行优化

## 处理数据倾斜

数倾斜的一般性原因：key分布不均匀、业务数据本身的特性、建表时考虑不周、某些SQL语句本身就有数据倾斜

1、数据倾斜很少发生在Map端，Map端的数据倾斜一般是HDFS数据存储不均匀导致的，而Reduce端则更容易发生数据倾斜，而Reduce阶段最容易出现数据倾斜的两个场景分别是Join和Count Distinct；如果只是使用Group By进行Sum或者Count操作，发生了数据倾斜可以先使用如下两个参数优化：

 ```properties
 set hive.map.aggr=true；(默认为ture) （map端的Combiner ）
 set hive.groupby.skewindata=true （默认为false）
 ```

​		解决数据倾斜首先要进行负载均衡操作，将上面两个参数设定为 true，而MapReduce进程则会生成两个额外的 MR Job，这两个任务的主要操作如下【面试高频】：

 - 第一步：MR Job 中Map 输出的结果集合首先会随机分配到 Reduce 中，然后每个 Reduce 做局部聚合操作并输出结果，这样处理的原因是相同的Group By Key有可能被分发到不同的 Reduce Job中，从而达到负载均衡的目的。

 - 第二步：MR Job 再根据预处理的数据结果按照 Group By Key 分布到 Reduce 中（这个过程可以保证相同的 Group By Key 被分布到同一个 Reduce 中），最后完成聚合操作。

   在设置好这两个参数之后，我们仍然需要针对不同的SQL语句进行SQL优化，主要分为两个场景， join操作发生的数据倾斜以及Count Distinct操作带来的数据倾斜。

**2、在Join场景下：**

- 方案一：使用Mapjoin进行关联

 ```properties
 set hive.auto.convert.join= ture; 设置自动化开启(默认为false)
 set hive.mapjoin.smalltable.filesize=25000000; 设置小表大小的上限（默认为25M）
 ```

- 方案二：将小表放入子查询 ，比如将与小表的Join改成in操作，但前提是小表的数据不会特别大

- 方案三：关联字段去重。很多时候发生数据倾斜是因为两表的关联字段有大量的重复值（大量Null也是一种情况）；

- 方案四：部分数据参数Join操作，过滤掉的不需要处理的数据后面再union回来

**3、在Count Distinct场景下：**

​		由于SQL中的Distinct操作本身会有一个全局排序的过程，一般情况下，不建议采用Count Distinct方式进行去重计数，除非表的数量比较小。当SQL中不存在分组字段时，Count Distinct操作仅生成一个Reduce 任务，该任务会对全部数据进行去重统计；当SQL中存在分组字段时，可能某些Reduce 任务需要去重统计的数量非常大。在这种情况下，我们可以通过以下方式替换：

 ​                 ![img](%E4%BC%98%E5%8C%96.assets/gG1wUi_2N5xwTovB7YP23A.png)        

如果语句中存在多个Distinct命令，开发者需要评估下用空间换时间的方法是否能够提升效率，具体的评估语法如下： ​           ![img](%E4%BC%98%E5%8C%96.assets/h9R_ruMuWzniJfqjAUtYhw.png)        

>
>综上，可以得到一些通用方法
>
>1、如果任务长时间卡在99%则基本可以认为是发生了数据倾斜，建议开发者调整参数以实现负载均衡：set hive.groupby.skewindata=true；
>
>2、小表关联大表操作，需要先看能否使用子查询，再看能否使用Mapjoin；
>
>3、Join操作注意关联字段不能出现大量的重复值或者空值；
>
>4、Count(distinct id ) 去重统计要慎用，尽量通过其他方式替换。
>
>部分资料参考：[深入浅出Hive数据倾斜 (getui.com)](https://www.getui.com/college/2021010444)